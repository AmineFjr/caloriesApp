<template>
  <div class="q-pa-md">
    <q-table
      flat bordered
      title="Liste des ingrédients"
      :rows="ingredients"
      :columns="columns"
      row-key="id"
      :filter="filter"
      white
      color="teal-6"
    >
      <template v-slot:top-right>
        <q-input borderless dense debounce="300" v-model="filter" placeholder="Rechercher">
          <template v-slot:append>
            <q-icon name="search" color="teal-4" />
          </template>
        </q-input>
      </template>

      <template v-slot:body-cell-actions="props">
        <q-td :props="props">
          <q-btn flat round dense color="teal-4" icon="edit" @click="editRow(props.row)" />
          <q-btn flat round dense color="teal-4" icon="delete" @click="deleteRow(props.row)" />
        </q-td>
      </template>
    </q-table>

    <!-- Update Form -->
    <div v-if="selectedIngredient" class="flex flex-center q-pa-md" style="max-width: 500px; margin: auto;">
      <div style="width: 100%;">
        <q-input color="teal-4" filled v-model="selectedIngredient.name" label="Nom" />
        <q-input color="teal-4" filled v-model="selectedIngredient.unit" label="Unité" />
        <q-input color="teal-4" filled v-model="selectedIngredient.calories" label="Calories" />
        <div class="text-center">
          <q-btn color="teal-4" @click="updateSelectedIngredient">Mettre à jour</q-btn>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from "vue";
import { useIngredientsStore } from "../stores/ingredient.js";

export default {
  setup () { 
    const store = useIngredientsStore();
    const ingredients = ref([]);
    const selectedIngredient = ref(null);
    const columns = [
      { name: 'name', required: true, label: 'Nom', align: 'left', field: 'name', sortable: true  },
      { name: 'unit', required: true, label: 'Unité', align: 'left', field: 'unit', sortable: true  },
      { name: 'calories', required: true, label: 'Calories', align: 'left', field: 'calories', sortable: true },
      { name: 'actions', required: true, label: 'Actions', align: 'left', field: 'id', sortable: false },
    ]

    async function deleteRow(row) {
      store.deleteIngredient(row.id);
    }

    function editRow(row) {
      selectedIngredient.value = { ...row };
    }

    async function updateSelectedIngredient() {
      if (!selectedIngredient.value) return;
      await store.updateIngredient(selectedIngredient.value);
      selectedIngredient.value = null;
    }

    onMounted(async() => {
      const result = await store.fetchIngredients();
      ingredients.value = result.ingredients;
    })

    return {
      filter: ref(''),
      columns,
      ingredients,
      selectedIngredient,
      deleteRow,
      editRow,
      updateSelectedIngredient,
    }
  }
}
</script>
